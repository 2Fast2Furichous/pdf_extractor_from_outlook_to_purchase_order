<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>PDF Data Extractor</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<script src="/eel.js"></script>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		html,
		body {
			height: 100%;
			overflow: hidden;
		}

		body {
			background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #3b82f6 100%);
			color: #ffffff;
			font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
			display: flex;
			height: 100vh;
			padding: 1rem;
			perspective: 1000px;
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
			width: 100%;
			height: calc(100vh - 3rem);
			/* More space for shadows */
			min-height: 620px;
			/* Increased to ensure button is always visible */
			display: grid;
			grid-template-rows: auto minmax(0, 1fr);
			/* Key: minmax prevents overflow */
			gap: 1rem;
			transform-style: preserve-3d;
			overflow: visible;
			/* Allow shadows to show */
			padding-bottom: 0.5rem;
			/* Extra padding for bottom shadows */
		}

		.header-section {
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 1rem;
			padding: 0.5rem 0;
			animation: header-animation 0.8s ease-out;
		}

		@keyframes header-animation {
			from {
				transform: translateY(-50px);
				opacity: 0;
			}

			to {
				transform: translateY(0);
				opacity: 1;
			}
		}

		.main-grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 1rem;
			min-height: 520px;
			/* Increased to ensure button area is always visible */
			height: 100%;
			overflow: visible;
			/* Changed from hidden to visible for shadows */
		}

		.form {
			position: relative;
			display: flex;
			flex-direction: column;
			gap: 10px;
			padding: 20px;
			background: rgba(0, 0, 0, 0.6);
			border-radius: 15px;
			overflow: hidden;
			perspective: 1000px;
			transform-style: preserve-3d;
			transform: translateZ(0);
			transition: all 0.3s ease-in-out;
			backdrop-filter: blur(10px);
			box-shadow:
				rgba(0, 0, 0, 0.6) 0px 2px 4px,
				rgba(0, 0, 0, 0.5) 0px 7px 13px -3px,
				rgba(0, 0, 0, 0.3) 0px -3px 0px inset;
			animation: form-animation 0.5s ease-in-out;
			position: relative;
			z-index: 1;
			min-height: 480px;
			/* Increased to ensure button always fits */
			max-height: 100%;
		}

		/* Special handling for left form to ensure button area */
		.form:first-child {
			padding-bottom: 80px;
			/* Extra padding to ensure button space */
		}

		/* Position the button area absolutely at bottom of left card */
		.form:first-child .text-center.mt-3 {
			position: absolute;
			bottom: 20px;
			left: 20px;
			right: 20px;
			margin-top: 0 !important;
		}

		.form:hover {
			transform: translateZ(5px) scale(1.01);
			z-index: 10;
		}

		@keyframes form-animation {
			from {
				transform: translateY(-20px);
				opacity: 0;
			}

			to {
				transform: translateZ(0);
				opacity: 1;
			}
		}

		.input {
			padding: 10px;
			border-radius: 15px;
			background: rgba(0, 0, 0, 0.4);
			border: 2px solid rgba(255, 255, 255, 0.2);
			backdrop-filter: blur(8px);
			box-shadow:
				0px 2px 4px rgba(0, 0, 0, 0.5),
				0px 7px 13px rgba(0, 0, 0, 0.3),
				inset 0px -3px 0px rgba(0, 0, 0, 0.2);
			color: white;
			transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
			transform-style: preserve-3d;
			backface-visibility: hidden;
			font-size: 12px;
			height: 35px;
			width: 100%;
			transform: perspective(1000px) rotateX(0deg) rotateY(0deg) translateZ(0px);
			will-change: transform;
		}

		.input::placeholder {
			color: rgba(255, 255, 255, 0.7);
		}

		input.input:hover,
		input[type="text"].input:hover,
		input[type="date"].input:hover,
		.input:hover {
			border-color: rgba(255, 255, 255, 0.4);
			background-color: rgba(0, 0, 0, 0.6);
			transform: perspective(1000px) rotateY(10deg) rotateX(4deg) translateZ(10px);
			box-shadow:
				-5px 5px 15px rgba(0, 0, 0, 0.6),
				0px 10px 25px rgba(59, 130, 246, 0.15),
				inset 0px -3px 0px rgba(0, 0, 0, 0.3);
		}

		input.input:focus,
		input[type="text"].input:focus,
		input[type="date"].input:focus,
		.input:focus {
			border-color: rgba(59, 130, 246, 0.6);
			background-color: rgba(0, 0, 0, 0.7);
			transform: perspective(1000px) rotateY(7deg) rotateX(2deg) translateZ(7px);
			box-shadow:
				-3px 3px 12px rgba(59, 130, 246, 0.3),
				0px 8px 20px rgba(0, 0, 0, 0.4),
				inset 0px -3px 0px rgba(59, 130, 246, 0.2);
			outline: none;
		}

		/* Special reduced rotation for email field due to its width */
		#email:hover {
			transform: perspective(1000px) rotateY(5deg) rotateX(2deg) translateZ(5px) !important;
		}

		#email:focus {
			transform: perspective(1000px) rotateY(3deg) rotateX(1deg) translateZ(3px) !important;
		}

		button,
		.btn {
			padding: 10px 20px;
			border: none;
			border-radius: 10px;
			background: rgba(0, 0, 0, 0.6);
			color: #fff;
			font-size: 13px;
			cursor: pointer;
			transform-style: preserve-3d;
			backface-visibility: hidden;
			transform: translateZ(0);
			transition: all 0.3s ease-in-out;
			box-shadow:
				rgba(0, 0, 0, 0.5) 0px 2px 4px,
				rgba(0, 0, 0, 0.4) 0px 7px 13px -3px,
				rgba(0, 0, 0, 0.3) 0px -3px 0px inset;
			text-transform: uppercase;
			font-weight: 600;
			letter-spacing: 0.5px;
			height: 35px;
			position: relative;
			z-index: 5;
		}

		button:hover,
		.btn:hover {
			background-color: rgba(255, 255, 255, 0.2);
			transform: translateZ(10px) scale(1.05);
			box-shadow:
				rgba(0, 0, 0, 0.5) 0px 4px 8px,
				rgba(0, 0, 0, 0.3) 0px 10px 20px,
				inset 0px -3px 0px rgba(0, 0, 0, 0.2);
			z-index: 15;
		}

		.btn-primary {
			background: rgba(59, 130, 246, 0.6);
		}

		.btn-primary:hover {
			background: rgba(59, 130, 246, 0.8);
		}

		.label {
			color: rgba(255, 255, 255, 0.9);
			font-size: 11px;
			font-weight: 600;
			margin-bottom: 5px;
			display: block;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}

		.progress-log {
			background: rgba(0, 0, 0, 0.4);
			border-radius: 15px;
			border: 2px solid rgba(255, 255, 255, 0.2);
			backdrop-filter: blur(8px);
			padding: 1rem;
			flex: 1;
			overflow-y: auto;
			overflow-x: hidden;
			box-shadow:
				0px 2px 4px rgba(0, 0, 0, 0.5),
				0px 7px 13px rgba(0, 0, 0, 0.3),
				inset 0px -3px 0px rgba(0, 0, 0, 0.2);
			position: relative;
			min-height: 0;
			/* Critical: allows flex item to shrink */
		}

		.progress-log::-webkit-scrollbar {
			width: 8px;
		}

		.progress-log::-webkit-scrollbar-track {
			background: rgba(0, 0, 0, 0.3);
			border-radius: 10px;
		}

		.progress-log::-webkit-scrollbar-thumb {
			background: rgba(59, 130, 246, 0.5);
			border-radius: 10px;
			transition: background 0.3s;
		}

		.progress-log::-webkit-scrollbar-thumb:hover {
			background: rgba(59, 130, 246, 0.7);
		}

		/* Ensure the right form column doesn't overflow */
		.form.progress-column {
			overflow: hidden;
			display: flex;
			flex-direction: column;
			min-height: 480px;
			/* Match left card minimum height */
		}

		.progress-bg {
			background: rgba(0, 0, 0, 0.4);
			height: 6px;
			border-radius: 10px;
			overflow: hidden;
			backdrop-filter: blur(5px);
		}

		.progress-fill {
			background: linear-gradient(90deg, #2a5298 0%, #3b82f6 100%);
			height: 100%;
			transition: width 0.3s ease;
		}

		.title {
			font-size: 24px;
			font-weight: 900;
			color: #ffffff;
			text-transform: uppercase;
			letter-spacing: 2px;
			text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
		}

		.subtitle {
			font-size: 11px;
			color: rgba(255, 255, 255, 0.8);
		}

		.section-heading {
			font-size: 12px;
			font-weight: 700;
			color: rgba(255, 255, 255, 0.9);
			text-transform: uppercase;
			letter-spacing: 0.5px;
			margin: 1rem 0 0.5rem 0;
			display: flex;
			align-items: center;
			gap: 0.5rem;
		}

		.icon-box {
			width: 50px;
			height: 50px;
			background: rgba(0, 0, 0, 0.6);
			border-radius: 15px;
			display: flex;
			align-items: center;
			justify-content: center;
			backdrop-filter: blur(10px);
			box-shadow:
				rgba(0, 0, 0, 0.6) 0px 2px 4px,
				rgba(0, 0, 0, 0.5) 0px 7px 13px -3px;
			transform: rotateX(-10deg);
			transition: transform 0.3s ease;
		}

		.icon-box:hover {
			transform: rotateX(0deg) scale(1.1);
		}

		.spinner {
			border: 2px solid rgba(255, 255, 255, 0.3);
			border-top: 2px solid #fff;
			border-radius: 50%;
			width: 24px;
			height: 24px;
			animation: spin 1s linear infinite;
		}

		@keyframes spin {
			0% {
				transform: rotate(0deg);
			}

			100% {
				transform: rotate(360deg);
			}
		}

		.status-dot {
			width: 8px;
			height: 8px;
			border-radius: 50%;
			display: inline-block;
			margin-right: 6px;
			box-shadow: 0 0 5px currentColor;
		}

		.status-dot.active {
			background: #4ade80;
		}

		.status-dot.processing {
			background: #fbbf24;
			animation: pulse 1s infinite;
		}

		.status-dot.error {
			background: #f87171;
		}

		@keyframes pulse {

			0%,
			100% {
				opacity: 1;
			}

			50% {
				opacity: 0.5;
			}
		}

		.divider {
			height: 1px;
			background: rgba(255, 255, 255, 0.2);
			margin: 1rem 0;
		}

		input[type="date"]::-webkit-calendar-picker-indicator {
			filter: invert(1);
			cursor: pointer;
			opacity: 0.7;
		}

		.grid-2 {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 0.75rem;
		}

		.flex {
			display: flex;
		}

		.flex-between {
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.gap-2 {
			gap: 0.5rem;
		}

		.text-center {
			text-align: center;
		}

		.hidden {
			display: none;
		}

		.mb-2 {
			margin-bottom: 0.5rem;
		}

		.mt-2 {
			margin-top: 0.5rem;
		}

		.mt-3 {
			margin-top: 0.75rem;
		}
	</style>
</head>

<body>
	<div class="container">
		<div class="header-section">
			<div class="icon-box">
				<svg xmlns="http://www.w3.org/2000/svg" style="width: 28px; height: 28px;" fill="none"
					viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
					<path stroke-linecap="round" stroke-linejoin="round"
						d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
					<path stroke-linecap="round" stroke-linejoin="round" d="M11 11l2 2m0 0l2-2m-2 2V7" />
				</svg>
			</div>
			<div>
				<h1 class="title">PDF DATA EXTRACTOR</h1>
				<p class="subtitle">Extract PO data from Outlook email attachments</p>
			</div>
		</div>

		<div class="main-grid">
			<form class="form">
				<div class="section-heading">
					<div style="width: 20px; height: 2px; background: rgba(255, 255, 255, 0.5);"></div>
					EMAIL FILTER
				</div>

				<label class="label">Email Address</label>
				<input type="text" id="email" placeholder="user@company.com" class="input">

				<div class="grid-2 mb-2">
					<div>
						<label class="label">Folder</label>
						<input type="text" id="folder" placeholder="Inbox" class="input">
					</div>
					<div>
						<label class="label">Subject</label>
						<input type="text" id="subject" placeholder="Purchase Order" class="input">
					</div>
				</div>

				<div class="grid-2 mb-2">
					<div>
						<label class="label">Start Date</label>
						<input type="date" id="startDate" class="input">
					</div>
					<div>
						<label class="label">End Date</label>
						<input type="date" id="endDate" class="input">
					</div>
				</div>

				<div class="divider"></div>

				<div class="section-heading">
					<div style="width: 20px; height: 2px; background: rgba(255, 255, 255, 0.5);"></div>
					OUTPUT SETTINGS
				</div>

				<label class="label">Output File</label>
				<div class="flex gap-2">
					<input type="text" id="outputPath" placeholder="PO_Data.xlsx" value="PO_Data.xlsx" class="input"
						style="flex: 1;">
					<button type="button" onclick="browseOutput()" class="btn">
						Browse
					</button>
				</div>

				<div class="text-center mt-3">
					<button type="button" id="extractBtn" onclick="startExtraction()" class="btn btn-primary"
						style="width: 200px;">
						Extract PDFs
					</button>
					<div id="loadingSpinner" class="hidden mt-2">
						<div class="spinner" style="margin: 0 auto;"></div>
						<p style="color: rgba(255, 255, 255, 0.7); font-size: 11px; margin-top: 6px;">Processing...</p>
					</div>
				</div>
			</form>

			<div class="form progress-column">
				<div class="section-heading">
					<div style="width: 20px; height: 2px; background: rgba(255, 255, 255, 0.5);"></div>
					PROGRESS
				</div>

				<div id="progressBarContainer" class="hidden mb-2">
					<div class="progress-bg">
						<div id="progressBar" class="progress-fill" style="width: 0%"></div>
					</div>
					<p style="color: rgba(255, 255, 255, 0.7); font-size: 11px; margin-top: 6px;" id="progressText"></p>
				</div>

				<div class="progress-log">
					<div id="progressLog" style="font-family: monospace; font-size: 11px; line-height: 1.4;">
						<p style="color: rgba(255, 255, 255, 0.7);">Ready to start extraction...</p>
					</div>
				</div>

				<div class="flex-between mt-3">
					<div class="flex" style="align-items: center;">
						<span class="status-dot active"></span>
						<span id="statusText" style="font-size: 11px; color: rgba(255, 255, 255, 0.8);">READY</span>
					</div>
					<div id="itemCount" style="font-size: 11px; color: rgba(255, 255, 255, 0.8);"></div>
				</div>
			</div>
		</div>
	</div>

	<script>
		let currentOutputPath = '';
		const MAX_LOG_LINES = 100; // Maximum number of log lines to show

		window.addEventListener('DOMContentLoaded', async () => {
			const settings = await eel.load_settings()();
			if (settings) {
				document.getElementById('email').value = settings.email_address || '';
				document.getElementById('folder').value = settings.folder_contains || '';
				document.getElementById('subject').value = settings.subject_contains || '';
				document.getElementById('outputPath').value = settings.output_path || 'PO_Data.xlsx';

				if (settings.start_date) {
					const startDate = convertDateToISO(settings.start_date);
					document.getElementById('startDate').value = startDate;
				}
				if (settings.end_date) {
					const endDate = convertDateToISO(settings.end_date);
					document.getElementById('endDate').value = endDate;
				}
			}
		});

		function convertDateToISO(dateStr) {
			if (!dateStr) return '';
			const parts = dateStr.split('/');
			if (parts.length !== 3) return '';
			return `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
		}

		function convertDateFromISO(dateStr) {
			if (!dateStr) return '';
			const parts = dateStr.split('-');
			if (parts.length !== 3) return '';
			return `${parts[1]}/${parts[2]}/${parts[0]}`;
		}

		async function browseOutput() {
			const filename = await eel.browse_output_file()();
			if (filename) {
				document.getElementById('outputPath').value = filename;
			}
		}

		async function startExtraction() {
			const email = document.getElementById('email').value;
			const folder = document.getElementById('folder').value;
			const subject = document.getElementById('subject').value;
			const startDate = convertDateFromISO(document.getElementById('startDate').value);
			const endDate = convertDateFromISO(document.getElementById('endDate').value);
			const outputPath = document.getElementById('outputPath').value;

			if (!email || !folder || !outputPath) {
				alert('Please fill in Email Address, Folder, and Output File fields.');
				return;
			}

			const settings = {
				email_address: email,
				folder_contains: folder,
				subject_contains: subject,
				start_date: startDate,
				end_date: endDate,
				output_path: outputPath
			};
			await eel.save_settings(settings)();

			document.getElementById('progressLog').innerHTML = '<p style="color: rgba(255, 255, 255, 0.9); font-size: 11px;">Starting extraction...</p>';

			const statusDot = document.querySelector('.status-dot');
			statusDot.classList.remove('active', 'error');
			statusDot.classList.add('processing');

			document.getElementById('extractBtn').disabled = true;
			document.getElementById('extractBtn').style.opacity = '0.5';
			document.getElementById('loadingSpinner').classList.remove('hidden');
			document.getElementById('progressBarContainer').classList.remove('hidden');
			document.getElementById('statusText').textContent = 'PROCESSING...';

			currentOutputPath = outputPath;

			await eel.extract_pdfs_from_outlook(email, folder, subject, startDate, endDate, outputPath)();
		}

		eel.expose(update_progress);
		function update_progress(message) {
			const logDiv = document.getElementById('progressLog');
			const newLine = document.createElement('p');
			newLine.textContent = message;
			newLine.style.fontSize = '11px';
			newLine.style.lineHeight = '1.4';

			if (message.includes('ERROR')) {
				newLine.style.color = '#ff6b6b';
				newLine.style.fontWeight = '700';
			} else if (message.includes('SUCCESS')) {
				newLine.style.color = '#51cf66';
				newLine.style.fontWeight = '700';
			} else if (message.includes('Warning')) {
				newLine.style.color = '#ffd43b';
			} else if (message.startsWith('  ')) {
				newLine.style.color = 'rgba(255, 255, 255, 0.6)';
				newLine.style.marginLeft = '10px';
			} else {
				newLine.style.color = 'rgba(255, 255, 255, 0.9)';
			}

			logDiv.appendChild(newLine);

			const lines = logDiv.getElementsByTagName('p');
			while (lines.length > MAX_LOG_LINES) {
				logDiv.removeChild(lines[0]);
			}

			const progressLogContainer = document.querySelector('.progress-log');
			if (progressLogContainer) {
				progressLogContainer.scrollTop = progressLogContainer.scrollHeight;
			}
		}

		eel.expose(update_status);
		function update_status(status) {
			document.getElementById('statusText').textContent = status.toUpperCase();
		}

		eel.expose(set_extraction_progress);
		function set_extraction_progress(current, total) {
			const percent = (current / total) * 100;
			document.getElementById('progressBar').style.width = `${percent}%`;
			document.getElementById('progressText').textContent = `${current} of ${total}`;
		}

		eel.expose(show_error);
		function show_error(message) {
			alert(`ERROR: ${message}`);
			const statusDot = document.querySelector('.status-dot');
			statusDot.classList.remove('active', 'processing');
			statusDot.classList.add('error');
			document.getElementById('statusText').textContent = 'ERROR';
		}

		eel.expose(show_warning);
		function show_warning(message) {
			alert(`WARNING: ${message}`);
		}

		eel.expose(show_info);
		function show_info(message) {
			alert(message);
		}

		eel.expose(ask_retry_pdf);
		function ask_retry_pdf(filename) {
			return confirm(`Cannot save PDF:\n${filename}\n\nFile may be open. Close it and click OK to retry.`);
		}

		eel.expose(ask_retry_file);
		function ask_retry_file(filepath, attempt, maxRetries) {
			return confirm(`Cannot write to:\n${filepath}\n\nClose the file and click OK.\n\nAttempt ${attempt} of ${maxRetries}`);
		}

		eel.expose(extraction_complete_with_prompt);
		function extraction_complete_with_prompt(itemCount, outputPath) {
			const statusDot = document.querySelector('.status-dot');
			statusDot.classList.remove('processing', 'error');
			statusDot.classList.add('active');

			document.getElementById('extractBtn').disabled = false;
			document.getElementById('extractBtn').style.opacity = '1';
			document.getElementById('loadingSpinner').classList.add('hidden');
			document.getElementById('statusText').textContent = 'COMPLETE';
			document.getElementById('itemCount').textContent = `${itemCount} items`;

			if (confirm(`Extracted ${itemCount} items.\n\nOpen output file?`)) {
				eel.open_file(outputPath)();
			}
		}
	</script>
</body>

</html>